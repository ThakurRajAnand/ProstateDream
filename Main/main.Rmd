---
title: "Main"
author: "Ann-Sophie Buchardt"
date: "02/09/2016"
output: html_document
---

```{r Preamble, echo=FALSE}
gc()

setwd("~/Dropbox/Science/projects/ProstateDream/Main/")
#setwd("c:/users/swmo/desktop/-/UCPH/DREAM/prostateDREAM/Main")
source("../Boosting/gbm.R")
source("../SurvivalForests/survForests.R")
source("../Imputation/imputation.R")
source("../SynapseScripts/score.R")
source("../Gam/gam.R")
source("../StabilitySelection/stabSelect.R")
library(survival)
library(xtable)
```

```{r Data}
load("../Data/Prostate_all.RData")
CoreTableDict <- read.table(file = "../Data/DataDictionary.csv", 
                            header = TRUE, sep = ";",
                            na.strings = c(" ", "", "."),
                            stringsAsFactors = FALSE)
```

### Data cleaning and preparation

```{r DataCleanFunction}
clean <- function(data, discard) {
  data <- transform(data, 
                    PSA = ifelse(PSA == 0, 0.01, PSA),
                    ECOG_C = factor((ECOG_C >= 1) + (ECOG_C >= 2)))
  data$RACE_C[data$RACE_C == "Missing"] <- NA
  data$REGION_C[data$REGION_C == "MISSING"] <- NA
  
  for (i in seq_len(ncol(data))) {
    if (is.factor(data[, i])) {
      tmp <- as.character(data[, i])
      tmp[tmp == ""] <- "NO"
      tmp[tmp == "Y"] <- "YES"
      data[, i] <- factor(tmp)
    }
    if (is.character(data[, i])) 
      data[, i] <- factor(data[, i])
    if (is.numeric(data[, i]))
      data[, i] <- as.numeric(data[, i])
  }

  data$DEATH <- ifelse(data$DEATH == "NO", 0, 1)

  data <- subset(data, select = -which(colnames(data) %in% discard))
}

```


```{r DataClean}
## List of variables that are discarded before the modeling
discard <-  c(
  ## Variables that are mostly or entirely missing in the training or validation data
  "HGTBLCAT", 
  "WGTBLCAT", 
  "HEAD_AND_NECK", 
  "PANCREAS", 
  "THYROID", 
  "CREACLCA", 
  "CREACL", 
  "GLEAS_DX", 
  "STOMACH",
  "BUN",
  "CCRC",
  "GLU",
  "HEIGHTBL",
  "WEIGHTBL",
  "ARTTHROM",
  ## Treatment variables
  "TRT1_ID",  
  "TRT1_ID", 
  "TRT2_ID", 
  "TRT3_ID",
  ## Discontinuation variables
  "DISCONT", 
  "ENTRT_PC", 
  "ENDTRS_C",
  ## Age not in validation data, only age group
  "AGEGRP",
  ## Misc
  "PER_REF",
  "LKADT_REF",
  "LKADT_PER",
  "DOMAIN",
  "STUDYID",
  "SMOKE",
  "SMOKFREQ",
  "SMOKSTAT",
  "RBC",
  "LYM",
  "ABDOMINAL",
  "MHNEOPLA",
  "TSTAG_DX"
  )

training <- clean(CoreTable_training, discard)
validation <- clean(CoreTable_validation, discard)

conVarCT <- CoreTableDict$Name[CoreTableDict$Type == "NUM" & CoreTableDict$Name %in% names(training)]
disVarCT <- CoreTableDict$Name[CoreTableDict$Type == "CHAR" & CoreTableDict$Name %in% names(training)]

## Check, should be character(0)
setdiff(c(conVarCT, disVarCT), colnames(training))
setdiff(c(conVarCT, disVarCT), colnames(validation))
```

### Exploratory plots

```{r}
source("../Exploratory/explorative.R")
```


### Survival in each of the three studies 

```{r survival}
prostateSurv0 <- survfit(Surv(LKADT_P, DEATH == "YES") ~ 1, data = CoreTable_training)
prostateSurv <- survfit(Surv(LKADT_P, DEATH == "YES") ~ STUDYID, data = CoreTable_training)
## Log-rank test
survdiff(Surv(LKADT_P, DEATH == "YES") ~ STUDYID, data = CoreTable_training)

survFit <- as.data.frame(summary(prostateSurv)[c(2, 6, 8)])
survFit$Trial <- {
  study <- survFit$strata; 
  levels(study) <- c("Mem. Sloan Kettering ", "Celgene", "Sanofi"); 
  study}

postscript(file = "Survival.eps", width = 5, height = 5,
           onefile = FALSE, horizontal = FALSE, paper = "special")
ggplot(survFit, aes(time, surv, color = Trial)) +
geom_ribbon(aes(x = time, y = NULL, ymin = lower, ymax = upper, color = NULL), 
            fill = "lightgray", color = "lightgray",
            data = as.data.frame(summary(prostateSurv0)[c(2, 9, 10)])) + 
  geom_step(size = I(0.8)) + 
  theme(legend.position = "top") + ylim(c(0, 1)) + 
  xlab("Days") + ylab("Survival function") + 
  theme(axis.title.y = element_text(margin = margin(0, 10, 0, 0)))
dev.off()
```

### Brief summary table

```{r summary}
rowSums(table(CoreTable_training[, c("STUDYID", "DEATH")]))
summary(subset(CoreTable_training, STUDYID == "EFC6546")[, "LKADT_P"])

trainTable <- CoreTableDict[CoreTableDict$Name %in% colnames(training), ][-(1:3),]
trainTable <- trainTable[order(trainTable$Type), ]
trainTable$missing <- apply(training[, trainTable$Name], 2, function(x) sum(is.na(x)))
trainTable$missingVal <- apply(validation[, trainTable$Name], 2, function(x) sum(is.na(x)))
trainTable$Name <- paste(rep(c("\\rowtwo ", "\\row "), times = 47)[-1], trainTable$Name)
trainTable$Label[40:93] <- sapply(strsplit(trainTable$Label[40:93], ":"), 
       function(x) tolower(x[length(x)]))




print(xtable(trainTable[, c(1, 2, 4, 8, 9)]), include.rownames = FALSE,
      file = "variables2.txt")
```

### ClassFrame

```{r}
logPreds <- c("CREAT", "LDH", "NEU", "PSA", "WBC", "CREACL", 
              "MG", "BUN", "CCRC")
catPreds <- c("RACE_C", "REGION_C", "ECOG_C", "STUDYID",
              "AGEGRP2", "SMOKE", "SMOKFREQ", "AGEGRP")
binPreds <- setdiff(names(training), c(conVarCT, catPreds))
nonPreds <- c("DOMAIN", "RPT", "LKADT_P", "DEATH", "DISCONT",
              "ENDTRS_C", "ENTRT_PC", "PER_REF", "LKADT_REF",
              "LKADT_PER")

classFrame <- data.frame(
  names = names(training), 
  modeltype = factor(rep("linear", ncol(training)),
                     levels = c("linear", "factor", "binary")),
  transform = factor(rep("id", ncol(training)), levels=c("id", "log"))
)

classFrame[classFrame$names %in% logPreds, "transform"] <- "log"
classFrame[classFrame$names %in% catPreds, "modeltype"] <- "factor"
classFrame[classFrame$names %in% binPreds, "modeltype"] <- "binary"

impute <- setdiff(
    names(training)[apply(is.na(training), 2, any)],
    nonPreds)
  
cF <- subset(classFrame, names %in% impute)
```


### Table of predictors

### Main training function

```{r}
trainModels <- function(train, 
                        test, 
                        methods = c("Lasso", "Cox", "GB", "GB*", "GBfull", "Forest", "Forest*", "Gam"),
                        cF, 
                        impute,
                        conVarCT,
                        disVarCT,
                        selectThres = 0.5,
                        trace = FALSE,
                        save.object = FALSE) {

  ####################
  ### Imputation  ####
  ####################
  
  idInd <- which("RPT" == names(train))
  if(trace) cat("MCAR train impute\n")
  trainMCAR <- imp(train, impute, impType = "MCAR")[, -idInd]
  if(trace) cat("MCAR test impute\n")
  testMCAR <- imp(test, impute, impType = "MCAR")[, -idInd]
  
  if(trace) cat("MAR train impute\n")
  trainMAR <- imp(train, impute, cF,
                  alpha = 0.05, min.obs.num = nrow(train), num.preds = 5,
                  key = "RPT", impType = "MAR", avoid = c(nonPreds, catPreds))[, -idInd]
  if(trace) cat("MAR test impute\n")
  testMAR <- imp(test, impute, cF,
                 alpha = 0.05, min.obs.num = nrow(test), num.preds = 5,
                 key = "RPT", impType = "MAR", avoid = c(nonPreds, catPreds))[, -idInd]
  
  if(trace) cat("MARwR train impute\n")
  trainMARwR <- imp(train, impute, cF,
                    alpha = 0.05, min.obs.num = nrow(train), num.preds = 5,
                    survobject = Surv(train$LKADT_P, train$DEATH == 1),
                    key = "RPT", impType = "MARresp", avoid = c(nonPreds, catPreds))[, -idInd]
  
  ## testMARwR is created with no imputation, prompting later functions to discard the incomplete cases
  testMARwR <- test[, -idInd]
  
  results <- list()
  
  ############################
  ### Stability selection ####
  ############################
  
  if(trace) cat("Stability selection\n")
  results$stabSelectMCAR <- stabSelect(trainMCAR, trace = trace)
  results$stabSelectMAR <- stabSelect(trainMAR, trace = trace)
  results$stabSelectMARwR <- stabSelect(trainMARwR, trace = trace)
  results$varSelectMCAR <- as.character(with(results$stabSelectMCAR, var[freq > selectThres]))
  results$varSelectMAR <- as.character(with(results$stabSelectMAR, var[freq > selectThres]))
  results$varSelectMARwR <- as.character(with(results$stabSelectMARwR, var[freq > selectThres]))

  #######################
  ### Fitting models ####
  #######################
  
  if("Lasso" %in% methods) {
  if(trace) cat("Lasso\n")
    results$lassoMCAR <- lasso(trainMCAR, testMCAR)
    results$lassoMAR <- lasso(trainMAR, testMAR)
    results$lassoMARwR <- lasso(trainMARwR, testMARwR)
    results$lassoDebiasMCAR <- lasso(trainMCAR, testMCAR, debiased = TRUE)
    results$lassoDebiasMAR <- lasso(trainMAR, testMAR, debiased = TRUE)
    results$lassoDebiasMARwR <- lasso(trainMARwR, testMARwR, debiased = TRUE)
  }
  
  if("Cox" %in% methods) {
    ## Cox with stability selection
    if(trace) cat("Cox\n")
    results$coxMCAR <- cox(trainMCAR, testMCAR, varSelectMCAR)
    results$coxMAR <- cox(trainMAR, testMAR, varSelectMAR)
    results$coxMARwR <- cox(trainMARwR, testMARwR, varSelectMARwR)
    ## Cox handles missing values by returning NA predictions
  }
  
  if("GB" %in% methods) {
    ## Gradient boosting with variable selection by the Lasso
    if(trace) cat("GB\n")
    results$gbMCAR <- gradBM(trainMCAR, testMCAR, ntrees = 1000, shrinkage = 1, verbose = trace)
    results$gbMAR <- gradBM(trainMAR, testMAR, ntrees = 1000, shrinkage = 1, verbose = trace)
    results$gbMARwR <- gradBM(trainMARwR, testMARwR, ntrees = 1000, shrinkage = 1, verbose = trace)
  }
  
  if("GB*" %in% methods) {
    ## Gradient boosting with stability selection
    if(trace) cat("GB*\n")
    results$gbStabMCAR <- gradBM(trainMCAR, testMCAR, varNames = varSelectMCAR, ntrees = 1000, shrinkage = 1, verbose = trace)
    results$gbStabMAR <- gradBM(trainMAR, testMAR, varNames = varSelectMAR, ntrees = 1000, shrinkage = 1, verbose = trace)
    results$gbStabMARwR <- gradBM(trainMARwR, testMARwR, varNames = varSelectMARwR, ntrees = 1000, shrinkage = 1, verbose = trace)
  }
  
  if("GBfull" %in% methods) {
    ## Gradient boosting with no variable selection
    if(trace) cat("GB full\n")
    results$gbFullMCAR <- gradBM(trainMCAR, testMCAR, ntrees = 1000, shrinkage = 1, verbose = trace, full = TRUE, save.object = save.object)
    results$gbFullMAR <- gradBM(trainMAR, testMAR, ntrees = 1000, shrinkage = 1, verbose = trace, full = TRUE, save.object = save.object)
  }
  
  if("Forest" %in% methods) {
    ## Survival forests
    if(trace) cat("Forest\n")
    results$forestMCAR <- survForest(trainMCAR, testMCAR, save.object = save.object)
    results$forestMAR <- survForest(trainMAR, testMAR, save.object = save.object)
  }
  
  if("Forest*" %in% methods) {
    ## Survival forests with stability selection
    if(trace) cat("Forest*\n")
    results$forestStabMCAR <- survForest(trainMCAR, testMCAR, varNames = varSelectMCAR)
    results$forestStabMAR <- survForest(trainMAR, testMAR, varNames = varSelectMAR)
    results$forestStabMARwR <- survForest(trainMARwR, testMARwR, varNames = varSelectMARwR)
  }
  
  if("Gam" %in% methods) {
    ## Gam with stability selection
    if(trace) cat("Gam\n")
    results$gamMCAR <- gamPred(trainMCAR, testMCAR, varNames = varSelectMCAR, conVarCT, disVarCT) 
    results$gamMAR <- gamPred(trainMAR, testMAR, varNames = varSelectMAR, conVarCT, disVarCT)
    results$gamMARwR <- gamPred(trainMARwR, testMARwR, varNames = varSelectMARwR, conVarCT, disVarCT)
  }
  
  results
}
```


### CV loop

```{r cvloop}
set.seed(10)
k <- 5 # number of CV folds
samp <- sample(rep(1:k, each = ceiling(nrow(training)/k)), 
               size = nrow(training), 
               replace = FALSE)

res_list <- list()

for (i in 1:k) {
  
  train <- training[samp != i, ]
  test <- training[samp == i, ]
 
results <- trainModels(train, test)

### Scoring models

# Scoring
scores <- data.frame(
  ## Lasso
  lassoMCAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$lassoMCAR)),
  lassoMAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$lassoMAR)),
  lassoMARwR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$lassoMARwR)),
  lassoDebiasMCAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$lassoDebiasMCAR)),
  lassoDebiasMAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$lassoDebiasMAR)),
  lassoDebiasMARwR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$lassoDebiasMARwR)),
  ## Cox
  coxMCAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$coxMCAR)),
  coxMAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$coxMAR)),
  coxMARwR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$coxMARwR)),
  ## Gradient boosting
  gbMCAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gbMCAR)),
  gbMAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gbMAR)),
  gbMARwR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gbMARwR)),
  gbStabMCAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gbStabMCAR)),
  gbStabMAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gbStabMAR)),
  gbStabMARwR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gbStabMARwR)),
  gbFullMCAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gbFullMCAR)),
  gbFullMAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gbFullMAR)),
  ## Forests
  forestMCAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$forestMCAR)),
  forestMAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$forestMAR)),
  forestStabMCAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$forestStabMCAR)),
  forestStabMAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$forestStabMAR)),
  forestStabMARwR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$forestStabMARwR)),
  ## Gam
  gamMCAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gamMCAR)),
  gamMAR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gamMAR)),
  gamMARwR = unlist(score_q1a(test$LKADT_P, test$DEATH, results$gamMARwR))
)
scores <- t(as.matrix(scores[, order(scores["iAUC", ], decreasing = TRUE)]))

res_list[[i]] <- scores
}
```


### Results

```{r results}
save(res_list, file = "mainResults2")
```

### Full models for validation submission

```{r}

result <- trainModels(
  train = training, 
  test = training, 
  cF = cF,
  impute = impute,
  conVarCT = conVarCT,
  disVarCT = disVarCT,
  methods = c("Lasso", "Forest", "GBfull"), 
  trace = TRUE,
  save.object = TRUE)
```

```{r vimp}
load("rsftrainMAR.RData")
rf.o.MAR <- rf.o
load("rsftrainMCAR.RData")
rf.o.MCAR <- rf.o
load("gbmtrainMAR.RData")
gbm.o.MAR <- gbm.o
load("gbmtrainMCAR.RData")
gbm.o.MCAR <- gbm.o

rm(rf.o, gbm.o)

vimp.MAR <- vimp(rf.o.MAR)
vimp.MCAR <- vimp(rf.o.MCAR)

vimp.MAR$importance[order(vimp.MAR$importance, decreasing = TRUE)]
vimp.MCAR$importance[order(vimp.MCAR$importance, decreasing = TRUE)]

summary(gbm.o.MAR, plotit = FALSE)
summary(gbm.o.MCAR, plotit = FALSE)

impor.df <- data.frame(rsf.MAR = names(vimp.MAR$importance[order(vimp.MAR$importance, decreasing = TRUE)]),
           rsf.MCAR = names(vimp.MCAR$importance[order(vimp.MCAR$importance, decreasing = TRUE)]),
           gbm.MAR = summary(gbm.o.MAR, plotit = FALSE)$var,
           gbm.MCAR = summary(gbm.o.MCAR, plotit = FALSE)$var)
impor.df
```



```{r selection}
postscript(file = "Selection.eps", width = 5, height = 15,
           onefile = FALSE, horizontal = FALSE, paper = "special")
p1 <- plot(result$stabSelectMCAR) + 
  theme(axis.title.y = element_text(margin = margin(0, 10, 0, 0))) +
  geom_label(aes(x = 15, y = 0.8, label = "MCAR")) +
  geom_abline(intercept = 0.5, slope = 0, color = "red")  
p2 <- plot(result$stabSelectMAR) + 
  theme(axis.title.y = element_text(margin = margin(0, 10, 0, 0))) +
  geom_label(aes(x = 15, y = 0.8, label = "MAR")) +
  geom_abline(intercept = 0.5, slope = 0, color = "red")  
p3 <- plot(result$stabSelectMARwR) + 
  theme(axis.title.y = element_text(margin = margin(0, 10, 0, 0))) +
  geom_label(aes(x = 15, y = 0.8, label = "MARwR")) +
  geom_abline(intercept = 0.5, slope = 0, color = "red")  
gridExtra::grid.arrange(p1, p2, p3, ncol=1)
dev.off()
```

