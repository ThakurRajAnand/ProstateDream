---
title: "Main"
author: "Ann-Sophie Buchardt"
date: "02/09/2016"
output: html_document
---

```{r Preamble, echo=FALSE}
gc()

#setwd("~/Dropbox/Science/projects/ProstateDream/Main/")
setwd("c:/users/swmo/desktop/-/UCPH/DREAM/prostateDREAM/Main")
source("../Boosting/gbm.R")
source("../SurvivalForests/survForests.R")
source("../Imputation/imputation.R")
source("../SynapseScripts/score.R")
source("../Gam/gam.R")
source("../StabilitySelection/stabSelect.R")
```

```{r Data}
load("../Data/Prostate_all.RData")
training <- CoreTable_training
CoreTableDict <- read.table(file = "../Data/DataDictionary.csv", 
                            header = TRUE, sep = ";",
                            na.strings = c(" ", "", "."),
                            stringsAsFactors = FALSE)

```

### Data preparation

```{r DataManipulation}
discard <-  c("HGTBLCAT", "WGTBLCAT", "HEAD_AND_NECK", 
              "PANCREAS", "THYROID", "CREACLCA", "CREACL", 
              "GLEAS_DX", "STOMACH")
training <- subset(training, select = -which(colnames(training) %in% discard))

training <- transform(training, 
                      PSA = ifelse(PSA == 0, 0.01, PSA),
                      ECOG_C = factor((ECOG_C >= 1) + (ECOG_C >= 2)))

for (i in seq_len(ncol(training))) {
  if (is.factor(training[, i])) {
    tmp <- as.character(training[, i])
    tmp[tmp == ""] <- "NO"
    training[, i] <- factor(tmp)
  }
}

training$RACE_C[training$RACE_C == "Missing"] <- NA
training$REGION_C[training$REGION_C == "MISSING"] <- NA

varLevels <- sapply(training, function(x) length(unique(x)))
oneVarLevel <- names(varLevels[varLevels == 1])
tt <- aggregate(x = training, by = list(training$STUDYID), function(x) {
   ifelse(sum(!duplicated(x)) == 1, NA, sum(!duplicated(x)))
})
nas <- colSums(is.na(tt))
notAllStudies <- names(training)[!(names(training) %in% names(nas[nas == 0]))]
notTwoStudies <- names(training)[!(names(training) %in% names(nas[nas %in% 0:1]))]
discardedVars <- c(oneVarLevel, notTwoStudies,
                  "DISCONT", "ENTRT_PC", "ENDTRS_C", "AGEGRP", 
                  "TRT1_ID", "TRT2_ID", "TRT3_ID")  
training <- subset(training, 
                   select = c(names(training)[!(names(training) %in% discardedVars)]))
 
conVarCT <- CoreTableDict$Name[CoreTableDict$Type == "NUM" & CoreTableDict$Name %in% names(training)]
disVarCT <- CoreTableDict$Name[CoreTableDict$Type == "CHAR" & CoreTableDict$Name %in% names(training)]

for(i in 1:length(conVarCT)){
  training[, conVarCT[i]] <- as.numeric(as.character(training[, conVarCT[i]]))
}
for(i in 1:length(disVarCT)){
  training[, disVarCT[i]] <- factor(training[, disVarCT[i]])
}

for(i in 1:length(disVarCT)) {
  if(nlevels(training[,disVarCT[i]]) == 2) {
    levels(training[,disVarCT[i]]) <- ifelse(levels(training[,disVarCT[i]]) == c("NO", "Y"), 
                                            c("NO", "YES"), 
                                            levels(training[,disVarCT[i]]))
  }
}

training$DEATH <- ifelse(training$DEATH == "NO", 0, 1)
```

### Splitting

```{r TestTraining}
# obsolete in the CV loop
#set.seed(10)
#train_idx <- sample(1:nrow(training), floor(0.8 * nrow(training)), replace = #FALSE)
#trainTemp <- training[train_idx, ] 
#testTemp <- training[-train_idx, ] 
```

### CV loop

```{r cvloop}
set.seed(10)
k <- 5 # number of CV folds
samp <- sample(rep(1:k, each = ceiling(nrow(training)/k)), 
               size = nrow(training), 
               replace = FALSE)

res_list <- list()

for (i in 1:k){
  
  trainTemp <- training[samp != i, ]
  testTemp <- training[samp == i, ]
 
### Imputations

# r classFrame
logPreds <- c("CREAT", "LDH", "NEU", "PSA", "WBC", "CREACL", 
              "MG", "BUN", "CCRC")
catPreds <- c("RACE_C", "REGION_C", "ECOG_C", "STUDYID",
              "AGEGRP2", "SMOKE", "SMOKFREQ", "AGEGRP")
binPreds <- setdiff(names(training), c(conVarCT, catPreds))
nonPreds <- c("DOMAIN", "RPT", "LKADT_P", "DEATH", "DISCONT",
              "ENDTRS_C", "ENTRT_PC", "PER_REF", "LKADT_REF",
              "LKADT_PER")

classFrame <- data.frame(
  names = names(training), 
  modeltype = factor(rep("linear", ncol(training)),
                     levels = c("linear", "factor", "binary")),
  transform = factor(rep("id", ncol(training)), levels=c("id", "log"))
)

classFrame[classFrame$names %in% logPreds, "transform"] <- "log"
classFrame[classFrame$names %in% catPreds, "modeltype"] <- "factor"
classFrame[classFrame$names %in% binPreds, "modeltype"] <- "binary"

impute <- setdiff(
  names(training)[apply(is.na(training), 2, any)],
  nonPreds)

# r x7imputations
cF <- subset(classFrame, names %in% impute)
idInd <- which("RPT" == names(training))

trainMCAR <- imp(trainTemp, impute, impType="MCAR")[, -idInd]
testMCAR <- imp(testTemp, impute, impType="MCAR")[, -idInd]

trainMAR <- imp(trainTemp, impute, cF,
                alpha=0.05, min.obs.num=nrow(trainTemp), num.preds=5,
                key="RPT", impType="MAR", avoid=c(nonPreds, catPreds))[, -idInd]

testMAR <- imp(testTemp, impute, cF,
               alpha=0.05, min.obs.num=nrow(testTemp), num.preds=5,
               key="RPT", impType="MAR", avoid=c(nonPreds, catPreds))[, -idInd]

trainMARwR <- imp(trainTemp, impute, cF,
                  alpha=0.05, min.obs.num=nrow(trainTemp), num.preds=5,
                  survobject=Surv(trainTemp$LKADT_P, trainTemp$DEATH==1),
                  key="RPT", impType="MARresp", avoid=c(nonPreds, catPreds))[, -idInd]

testMARwR <- testTemp[, -idInd]
# note: testMARwR is created with no imputation, prompting later functions to discard the incomplete cases


### Stability selection

# r stabilitySelection

stabSelectMCAR <- stabSelect(trainMCAR, trace = FALSE)
stabSelectMAR <- stabSelect(trainMAR, trace = FALSE)
stabSelectMARwR <- stabSelect(trainMARwR, trace = FALSE)
varSelectMCAR <- as.character(with(stabSelectMCAR, var[freq > 0.5]))
varSelectMAR <- as.character(with(stabSelectMAR, var[freq > 0.5]))
varSelectMARwR <- as.character(with(stabSelectMARwR, var[freq > 0.5]))

# r, fig.height=12
p1 <- plot(stabSelectMCAR)
p2 <- plot(stabSelectMAR)
p3 <- plot(stabSelectMARwR)
gridExtra::grid.arrange(p1, p2, p3, ncol=1)

### Fitting models

# r lasso
lassoMCAR <- lasso(trainMCAR, testMCAR)
lassoMAR <- lasso(trainMAR, testMAR)
lassoMARwR <- lasso(trainMARwR, test = testMARwR)
lassoDebiasMCAR <- lasso(trainMCAR, testMCAR, debiased = TRUE)
lassoDebiasMAR <- lasso(trainMAR, testMAR, debiased = TRUE)
lassoDebiasMARwR <- lasso(trainMARwR, testMARwR, debiased = TRUE)

# r Stability_selection_with_coxph
coxMCAR <- cox(trainMCAR, testMCAR, varSelectMCAR)
coxMAR <- cox(trainMAR, testMAR, varSelectMAR)
coxMARwR <- cox(trainMARwR, testMARwR, varSelectMARwR)
# cox handles missing values by return NA predictions

# r Gradient_boosting, warning=FALSE
gbMCAR <- gradBM(trainMCAR, testMCAR, ntrees = 1000, shrinkage = 1, verbose = FALSE)
gbMAR <- gradBM(trainMAR, testMAR, ntrees = 1000, shrinkage = 1, verbose = FALSE)
gbMARwR <- gradBM(trainMARwR, testMARwR, ntrees = 1000, shrinkage = 1, verbose = FALSE)

# r Gradient_boosting_with_stability_selection, warning=FALSE
gbStabMCAR <- gradBM(trainMCAR, testMCAR, varNames = varSelectMCAR, ntrees = 1000, shrinkage = 1, verbose = FALSE)
gbStabMAR <- gradBM(trainMAR, testMAR, varNames = varSelectMAR, ntrees = 1000, shrinkage = 1, verbose = FALSE)
gbStabMARwR <- gradBM(trainMARwR, testMARwR, varNames = varSelectMARwR, ntrees = 1000, shrinkage = 1, verbose = FALSE)

# r Gradient boosting with no variable selection

gbFullMCAR <- gradBM(trainMCAR, testMCAR, ntrees = 1000, shrinkage = 1, verbose = FALSE, full = TRUE)
gbFullMAR <- gradBM(trainMAR, testMAR, ntrees = 1000, shrinkage = 1, verbose = FALSE, full = TRUE)

# r Survival_forests
forestMCAR <- survForest(trainMCAR, testMCAR)
forestMAR <- survForest(trainMAR, testMAR)


# r Survival_forests_stability_selection
forestStabMCAR <- survForest(trainMCAR, testMCAR, varNames = varSelectMCAR)
forestStabMAR <- survForest(trainMAR, testMAR, varNames = varSelectMAR)
forestStabMARwR <- survForest(trainMARwR, testMARwR, varNames = varSelectMARwR)

# r GAM
gamMCAR <- gamPred(trainMCAR, testMCAR, varNames = varSelectMCAR, conVarCT, disVarCT) 
gamMAR <- gamPred(trainMAR, testMAR, varNames = varSelectMAR, conVarCT, disVarCT)
gamMARwR <- gamPred(trainMARwR, testMARwR, varNames = varSelectMARwR, conVarCT, disVarCT)


### Scoring models

# r scoring
options(digits=3, width=100)
scores <- data.frame(
  ## Lasso
  lassoMCAR = unlist(score_q1a(testMCAR$LKADT_P, testMCAR$DEATH, lassoMCAR)),
  lassoMAR = unlist(score_q1a(testMAR$LKADT_P, testMAR$DEATH, lassoMAR)),
  lassoMARwR = unlist(score_q1a(testMARwR$LKADT_P, testMARwR$DEATH, lassoMARwR)),
  lassoDebiasMCAR = unlist(score_q1a(testMCAR$LKADT_P, testMCAR$DEATH, lassoDebiasMCAR)),
  lassoDebiasMAR = unlist(score_q1a(testMAR$LKADT_P, testMAR$DEATH, lassoDebiasMAR)),
  lassoDebiasMARwR = unlist(score_q1a(testMARwR$LKADT_P, testMARwR$DEATH, lassoDebiasMARwR)),
  ## Cox
  coxMCAR = unlist(score_q1a(testMCAR$LKADT_P, testMCAR$DEATH, coxMCAR)),
  coxMAR = unlist(score_q1a(testMAR$LKADT_P, testMAR$DEATH, coxMAR)),
  coxMARwR = unlist(score_q1a(testMARwR$LKADT_P, testMARwR$DEATH, coxMARwR)),
  ## Gradient boosting
  gbMCAR = unlist(score_q1a(testMCAR$LKADT_P, testMCAR$DEATH, gbMCAR)),
  gbMAR = unlist(score_q1a(testMAR$LKADT_P, testMAR$DEATH, gbMAR)),
  gbMARwR = unlist(score_q1a(testMARwR$LKADT_P, testMARwR$DEATH, gbMARwR)),
  gbStabMCAR = unlist(score_q1a(testMCAR$LKADT_P, testMCAR$DEATH, gbStabMCAR)),
  gbStabMAR = unlist(score_q1a(testMAR$LKADT_P, testMAR$DEATH, gbStabMAR)),
  gbStabMARwR = unlist(score_q1a(testMARwR$LKADT_P, testMARwR$DEATH, gbStabMARwR)),
  gbFullMCAR = unlist(score_q1a(testMCAR$LKADT_P, testMCAR$DEATH, gbFullMCAR)),
  gbFullMAR = unlist(score_q1a(testMAR$LKADT_P, testMAR$DEATH, gbFullMAR)),
  ## Forests
  forestMCAR = unlist(score_q1a(testMCAR$LKADT_P, testMCAR$DEATH, forestMCAR)),
  forestMAR = unlist(score_q1a(testMAR$LKADT_P, testMAR$DEATH, forestMAR)),
  forestStabMCAR = unlist(score_q1a(testMCAR$LKADT_P, testMCAR$DEATH, forestStabMCAR)),
  forestStabMAR = unlist(score_q1a(testMAR$LKADT_P, testMAR$DEATH, forestStabMAR)),
  forestStabMARwR = unlist(score_q1a(testMARwR$LKADT_P, testMARwR$DEATH, forestStabMARwR)),
  ## Gam
  gamMCAR = unlist(score_q1a(testMCAR$LKADT_P, testMCAR$DEATH, gamMCAR)),
  gamMAR = unlist(score_q1a(testMAR$LKADT_P, testMAR$DEATH, gamMAR)),
  gamMARwR = unlist(score_q1a(testMARwR$LKADT_P, testMARwR$DEATH, gamMARwR))
)
scores <- t(as.matrix(scores[, order(scores["iAUC", ], decreasing = TRUE)]))

res_list[[i]] <- scores
options(digits=7, width=80)

}
```


### Results

```{r results}
save(res_list, file = "mainResults")
```